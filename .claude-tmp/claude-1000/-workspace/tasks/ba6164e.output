Traceback (most recent call last):
  File "/tmp/tmp.4aD8lk91LQ", line 1, in <module>
    {"exit_code":0,"stderr":"","stdout":"diff --git a/PLAN-CHECKLIST.md b/PLAN-CHECKLIST.md\nindex 8be74ac..c0b96ef 100644\n--- a/PLAN-CHECKLIST.md\n+++ b/PLAN-CHECKLIST.md\n@@ -7,25 +7,25 @@ Tracks progress against [PLAN.md](./PLAN.md). Check items as completed.\n ## Phase 1: Quick Wins\n \n ### 1. Query Clarification Phase\n-- [ ] Add `CLARIFICATION` to `DeepResearchPhase` enum in `models/deep_research.py`\n-- [ ] Add `clarification_constraints` dict field to `DeepResearchState`\n-- [ ] Add `CLARIFIER` to `AgentRole` enum in `orchestration.py`\n-- [ ] Create `phases/clarification.py` with `ClarificationPhaseMixin`\n-  - [ ] `_execute_clarification_async()` \u2014 single LLM call\n-  - [ ] `_build_clarification_system_prompt()` \u2014 structured JSON output instructions\n-  - [ ] `_build_clarification_user_prompt()` \u2014 original query + any user context\n-  - [ ] `_parse_clarification_response()` \u2014 extract questions / constraints\n-- [ ] Wire into `workflow_execution.py` before planning phase\n-- [ ] Register mixin in `core.py` (`DeepResearchWorkflow` class)\n-- [ ] Add config keys to `.foundry-mcp.toml`:\n-  - [ ] `deep_research_allow_clarification` (default: `true`)\n-  - [ ] `deep_research_clarification_provider`\n-- [ ] Handle \"skip\" path \u2014 if user doesn't answer, proceed with original query\n+- [x] Add `CLARIFICATION` to `DeepResearchPhase` enum in `models/deep_research.py`\n+- [x] Add `clarification_constraints` dict field to `DeepResearchState`\n+- [x] Add `CLARIFIER` to `AgentRole` enum in `orchestration.py`\n+- [x] Create `phases/clarification.py` with `ClarificationPhaseMixin`\n+  - [x] `_execute_clarification_async()` \u2014 single LLM call\n+  - [x] `_build_clarification_system_prompt()` \u2014 structured JSON output instructions\n+  - [x] `_build_clarification_user_prompt()` \u2014 original query + any user context\n+  - [x] `_parse_clarification_response()` \u2014 extract questions / constraints\n+- [x] Wire into `workflow_execution.py` before planning phase\n+- [x] Register mixin in `core.py` (`DeepResearchWorkflow` class)\n+- [x] Add config keys to `.foundry-mcp.toml`:\n+  - [x] `deep_research_allow_clarification` (default: `true`)\n+  - [x] `deep_research_clarification_provider`\n+- [x] Handle \"skip\" path \u2014 if user doesn't answer, proceed with original query\n - [ ] Unit tests for clarification parsing\n - [ ] Integration test: query \u2192 clarification \u2192 planning flow\n \n ### 4. Proactive Content Digest\n-- [ ] Add `\"proactive\"` to `deep_research_digest_policy` validation\n+- [x] Add `\"proactive\"` to `deep_research_digest_policy` validation\n - [ ] In `phases/gathering.py`, add post-gather digest step:\n   - [ ] Check if policy is `proactive`\n   - [ ] Call `DocumentDigestor` on each newly gathered source\ndiff --git a/src/foundry_mcp/config/research.py b/src/foundry_mcp/config/research.py\nindex 775bae9..fad147b 100644\n--- a/src/foundry_mcp/config/research.py\n+++ b/src/foundry_mcp/config/research.py\n@@ -86,6 +86,10 @@ class ResearchConfig:\n     thinkdeep_max_depth: int = 5\n     ideate_perspectives: List[str] = field(default_factory=lambda: [\"technical\", \"creative\", \"practical\", \"visionary\"])\n     default_timeout: float = 360.0  # 360 seconds default for AI CLI providers\n+    # Deep research clarification phase configuration\n+    deep_research_allow_clarification: bool = True\n+    deep_research_clarification_provider: Optional[str] = None  # Uses default_provider if not set\n+\n     # Deep research configuration\n     deep_research_max_iterations: int = 3\n     deep_research_max_sub_queries: int = 5\n@@ -263,6 +267,9 @@ class ResearchConfig:\n             thinkdeep_max_depth=int(data.get(\"thinkdeep_max_depth\", 5)),\n             ideate_perspectives=ideate_perspectives,\n             default_timeout=float(data.get(\"default_timeout\", 360.0)),\n+            # Deep research clarification phase\n+            deep_research_allow_clarification=_parse_bool(data.get(\"deep_research_allow_clarification\", True)),\n+            deep_research_clarification_provider=data.get(\"deep_research_clarification_provider\"),\n             # Deep research configuration\n             deep_research_max_iterations=int(data.get(\"deep_research_max_iterations\", 3)),\n             deep_research_max_sub_queries=int(data.get(\"deep_research_max_sub_queries\", 5)),\n@@ -564,7 +571,7 @@ class ResearchConfig:\n             ValueError: If any digest config field has an invalid value.\n         \"\"\"\n         # Validate digest_policy\n-        valid_policies = {\"off\", \"auto\", \"always\"}\n+        valid_policies = {\"off\", \"auto\", \"always\", \"proactive\"}\n         if self.deep_research_digest_policy not in valid_policies:\n             raise ValueError(\n                 f\"Invalid deep_research_digest_policy: {self.deep_research_digest_policy!r}. \"\n@@ -644,6 +651,7 @@ class ResearchConfig:\n             Timeout in seconds for the phase\n         \"\"\"\n         phase_timeouts = {\n+            \"clarification\": self.deep_research_planning_timeout,  # Reuse planning timeout\n             \"planning\": self.deep_research_planning_timeout,\n             \"analysis\": self.deep_research_analysis_timeout,\n             \"synthesis\": self.deep_research_synthesis_timeout,\ndiff --git a/src/foundry_mcp/core/research/models/deep_research.py b/src/foundry_mcp/core/research/models/deep_research.py\nindex af71494..8a78e40 100644\n--- a/src/foundry_mcp/core/research/models/deep_research.py\n+++ b/src/foundry_mcp/core/research/models/deep_research.py\n@@ -99,7 +99,8 @@ class DeepResearchConfig(BaseModel):\n class DeepResearchPhase(str, Enum):\n     \"\"\"Phases of the DEEP_RESEARCH workflow.\n \n-    The deep research workflow progresses through five sequential phases:\n+    The deep research workflow progresses through six sequential phases:\n+    0. CLARIFICATION - (Optional) Analyze query specificity and ask clarifying questions\n     1. PLANNING - Analyze the query and decompose into focused sub-queries\n     2. GATHERING - Execute sub-queries in parallel and collect sources\n     3. ANALYSIS - Extract findings and assess source quality\n@@ -110,6 +111,7 @@ class DeepResearchPhase(str, Enum):\n     progression through advance_phase() method.\n     \"\"\"\n \n+    CLARIFICATION = \"clarification\"\n     PLANNING = \"planning\"\n     GATHERING = \"gathering\"\n     ANALYSIS = \"analysis\"\n@@ -131,6 +133,10 @@ class DeepResearchState(BaseModel):\n \n     id: str = Field(default_factory=lambda: f\"deepres-{uuid4().hex[:12]}\")\n     original_query: str = Field(..., description=\"The original research query\")\n+    clarification_constraints: dict[str, Any] = Field(\n+        default_factory=dict,\n+        description=\"Constraints and context inferred or provided during CLARIFICATION phase\",\n+    )\n     research_brief: Optional[str] = Field(\n         default=None,\n         description=\"Expanded research plan generated in PLANNING phase\",\ndiff --git a/src/foundry_mcp/core/research/workflows/deep_research/action_handlers.py b/src/foundry_mcp/core/research/workflows/deep_research/action_handlers.py\nindex 0768d5c..8002ff2 100644\n--- a/src/foundry_mcp/core/research/workflows/deep_research/action_handlers.py\n+++ b/src/foundry_mcp/core/research/workflows/deep_research/action_handlers.py\n@@ -13,6 +13,7 @@ from typing import TYPE_CHECKING, Any, Optional\n \n from foundry_mcp.core import task_registry\n from foundry_mcp.core.research.models.deep_research import (\n+    DeepResearchPhase,\n     DeepResearchState,\n )\n from foundry_mcp.core.research.models.sources import ResearchMode\n@@ -108,9 +109,15 @@ class ActionHandlersMixin:\n         synthesis_pid, synthesis_model = self.config.resolve_phase_provider(\"synthesis\")\n         refinement_pid, refinement_model = self.config.resolve_phase_provider(\"refinement\")\n \n+        # Determine initial phase: CLARIFICATION if enabled, else PLANNING\n+        initial_phase = DeepResearchPhase.PLANNING\n+        if getattr(self.config, \"deep_research_allow_clarification\", False):\n+            initial_phase = DeepResearchPhase.CLARIFICATION\n+\n         # Create initial state with per-phase provider configuration\n         state = DeepResearchState(\n             original_query=query,\n+            phase=initial_phase,\n             max_iterations=max_iterations,\n             max_sub_queries=max_sub_queries,\n             max_sources_per_query=max_sources_per_query,\ndiff --git a/src/foundry_mcp/core/research/workflows/deep_research/core.py b/src/foundry_mcp/core/research/workflows/deep_research/core.py\nindex 7826361..15d4825 100644\n--- a/src/foundry_mcp/core/research/workflows/deep_research/core.py\n+++ b/src/foundry_mcp/core/research/workflows/deep_research/core.py\n@@ -60,6 +60,9 @@ from foundry_mcp.core.research.workflows.deep_research.persistence import (\n from foundry_mcp.core.research.workflows.deep_research.phases.analysis import (\n     AnalysisPhaseMixin,\n )\n+from foundry_mcp.core.research.workflows.deep_research.phases.clarification import (\n+    ClarificationPhaseMixin,\n+)\n from foundry_mcp.core.research.workflows.deep_research.phases.gathering import (\n     GatheringPhaseMixin,\n )\n@@ -98,6 +101,7 @@ class DeepResearchWorkflow(\n     ErrorHandlingMixin,\n     ActionHandlersMixin,\n     WorkflowExecutionMixin,\n+    ClarificationPhaseMixin,\n     PlanningPhaseMixin,\n     GatheringPhaseMixin,\n     AnalysisPhaseMixin,\ndiff --git a/src/foundry_mcp/core/research/workflows/deep_research/orchestration.py b/src/foundry_mcp/core/research/workflows/deep_research/orchestration.py\nindex d0662d7..59b1654 100644\n--- a/src/foundry_mcp/core/research/workflows/deep_research/orchestration.py\n+++ b/src/foundry_mcp/core/research/workflows/deep_research/orchestration.py\n@@ -30,6 +30,8 @@ class AgentRole(str, Enum):\n     - SUPERVISOR: Orchestrates phase transitions, evaluates quality gates,\n       decides on iteration vs completion. The supervisor runs think-tool\n       pauses between phases to evaluate progress and adjust strategy.\n+    - CLARIFIER: Evaluates query specificity and generates clarifying\n+      questions. Infers constraints from vague queries to focus research.\n     - PLANNER: Decomposes the original query into focused sub-queries,\n       generates the research brief, and identifies key themes to explore.\n     - GATHERER: Executes parallel search across providers, handles rate\n@@ -43,6 +45,7 @@ class AgentRole(str, Enum):\n     \"\"\"\n \n     SUPERVISOR = \"supervisor\"\n+    CLARIFIER = \"clarifier\"\n     PLANNER = \"planner\"\n     GATHERER = \"gatherer\"\n     ANALYZER = \"analyzer\"\n@@ -52,6 +55,7 @@ class AgentRole(str, Enum):\n \n # Mapping from workflow phases to specialist agents\n PHASE_TO_AGENT: dict[DeepResearchPhase, AgentRole] = {\n+    DeepResearchPhase.CLARIFICATION: AgentRole.CLARIFIER,\n     DeepResearchPhase.PLANNING: AgentRole.PLANNER,\n     DeepResearchPhase.GATHERING: AgentRole.GATHERER,\n     DeepResearchPhase.ANALYSIS: AgentRole.ANALYZER,\n@@ -250,11 +254,17 @@ class SupervisorOrchestrator:\n             \"iteration\": state.iteration,\n         }\n \n-        if phase == DeepResearchPhase.PLANNING:\n+        if phase == DeepResearchPhase.CLARIFICATION:\n+            return {\n+                **base_inputs,\n+                \"system_prompt\": state.system_prompt,\n+            }\n+        elif phase == DeepResearchPhase.PLANNING:\n             return {\n                 **base_inputs,\n                 \"system_prompt\": state.system_prompt,\n                 \"max_sub_queries\": state.max_sub_queries,\n+                \"clarification_constraints\": state.clarification_constraints,\n             }\n         elif phase == DeepResearchPhase.GATHERING:\n             return {\n@@ -327,7 +337,18 @@ class SupervisorOrchestrator:\n \n         Returns metrics and a proceed/retry recommendation.\n         \"\"\"\n-        if phase == DeepResearchPhase.PLANNING:\n+        if phase == DeepResearchPhase.CLARIFICATION:\n+            has_constraints = bool(state.clarification_constraints)\n+            return {\n+                \"has_constraints\": has_constraints,\n+                \"quality_ok\": True,  # Clarification always proceeds\n+                \"rationale\": (\n+                    f\"Clarification {'provided constraints' if has_constraints else 'skipped/no constraints needed'}. \"\n+                    \"Proceeding to planning.\"\n+                ),\n+            }\n+\n+        elif phase == DeepResearchPhase.PLANNING:\n             sub_query_count = len(state.sub_queries)\n             quality_ok = sub_query_count >= 2  # At least 2 sub-queries\n             return {\n@@ -460,6 +481,10 @@ class SupervisorOrchestrator:\n             Prompt for supervisor reflection\n         \"\"\"\n         prompts = {\n+            DeepResearchPhase.CLARIFICATION: (\n+                f\"Clarification complete. Constraints: {bool(state.clarification_constraints)}. \"\n+                \"Evaluate: Is the query now specific enough for focused research?\"\n+            ),\n             DeepResearchPhase.PLANNING: (\n                 f\"Planning complete. Generated {len(state.sub_queries)} sub-queries. \"\n                 f\"Research brief: {bool(state.research_brief)}. \"\ndiff --git a/src/foundry_mcp/core/research/workflows/deep_research/phases/__init__.py b/src/foundry_mcp/core/research/workflows/deep_research/phases/__init__.py\nindex 46bafba..c625777 100644\n--- a/src/foundry_mcp/core/research/workflows/deep_research/phases/__init__.py\n+++ b/src/foundry_mcp/core/research/workflows/deep_research/phases/__init__.py\n@@ -5,12 +5,14 @@ They are combined via multiple inheritance in the main DeepResearchWorkflow clas\n \"\"\"\n \n from .analysis import AnalysisPhaseMixin\n+from .clarification import ClarificationPhaseMixin\n from .gathering import GatheringPhaseMixin\n from .planning import PlanningPhaseMixin\n from .refinement import RefinementPhaseMixin\n from .synthesis import SynthesisPhaseMixin\n \n __all__ = [\n+    \"ClarificationPhaseMixin\",\n     \"PlanningPhaseMixin\",\n     \"GatheringPhaseMixin\",\n     \"AnalysisPhaseMixin\",\ndiff --git a/src/foundry_mcp/core/research/workflows/deep_research/phases/planning.py b/src/foundry_mcp/core/research/workflows/deep_research/phases/planning.py\nindex 02a64a2..7ff9017 100644\n--- a/src/foundry_mcp/core/research/workflows/deep_research/phases/planning.py\n+++ b/src/foundry_mcp/core/research/workflows/deep_research/phases/planning.py\n@@ -228,6 +228,12 @@ Generate the research plan as JSON.\"\"\"\n         if state.system_prompt:\n             prompt += f\"\\n\\nAdditional context: {state.system_prompt}\"\n \n+        # Add clarification constraints if available (from clarification phase)\n+        if state.clarification_constraints:\n+            prompt += \"\\n\\nClarification constraints (use these to focus the research):\"\n+            for key, value in state.clarification_constraints.items():\n+                prompt += f\"\\n- {key}: {value}\"\n+\n         return prompt\n \n     def _parse_planning_response(\ndiff --git a/src/foundry_mcp/core/research/workflows/deep_research/workflow_execution.py b/src/foundry_mcp/core/research/workflows/deep_research/workflow_execution.py\nindex 7128e17..276b836 100644\n--- a/src/foundry_mcp/core/research/workflows/deep_research/workflow_execution.py\n+++ b/src/foundry_mcp/core/research/workflows/deep_research/workflow_execution.py\n@@ -59,6 +59,7 @@ class WorkflowExecutionMixin:\n         def _flush_state(self, *args: Any, **kwargs: Any) -> None: ...\n         def _record_workflow_error(self, *args: Any, **kwargs: Any) -> None: ...\n         def _safe_orchestrator_transition(self, *args: Any, **kwargs: Any) -> Any: ...\n+        async def _execute_clarification_async(self, *args: Any, **kwargs: Any) -> Any: ...\n         async def _execute_planning_async(self, *args: Any, **kwargs: Any) -> Any: ...\n         async def _execute_gathering_async(self, *args: Any, **kwargs: Any) -> Any: ...\n         async def _execute_analysis_async(self, *args: Any, **kwargs: Any) -> Any: ...\n@@ -164,6 +165,22 @@ class WorkflowExecutionMixin:\n \n         try:\n             # Phase execution based on current state\n+            if state.phase == DeepResearchPhase.CLARIFICATION:\n+                err = await self._run_phase(\n+                    state,\n+                    DeepResearchPhase.CLARIFICATION,\n+                    self._execute_clarification_async(\n+                        state=state,\n+                        provider_id=(\n+                            getattr(self.config, \"deep_research_clarification_provider\", None)\n+                            or self.config.default_provider\n+                        ),\n+                        timeout=self.config.get_phase_timeout(\"planning\"),  # Reuse planning timeout\n+                    ),\n+                )\n+                if err:\n+                    return err\n+\n             if state.phase == DeepResearchPhase.PLANNING:\n                 err = await self._run_phase(\n                     state,\n","truncated":false}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ^^^^^
NameError: name 'false' is not defined. Did you mean: 'False'?
