{
  "spec_id": "autonomy-orchestrator-improvements-2026-02-19-001",
  "title": "autonomy-orchestrator-improvements",
  "generated": "2026-02-19T23:07:19.816737Z",
  "last_updated": "2026-02-19T23:08:55.263653Z",
  "metadata": {
    "description": "",
    "mission": "Fix fidelity gate deadlock caused by stale pending_gate_evidence, improve step emission API hints (outcome values and required parameters), and enforce acceptance criteria universally across all spec complexity levels.",
    "objectives": [],
    "complexity": "low",
    "estimated_hours": 7.0,
    "assumptions": [],
    "owner": "",
    "category": "implementation",
    "template": "empty"
  },
  "progress_percentage": 0,
  "status": "pending",
  "current_phase": null,
  "hierarchy": {
    "spec-root": {
      "type": "spec",
      "title": "autonomy-orchestrator-improvements",
      "status": "pending",
      "parent": null,
      "children": [
        "phase-1",
        "phase-2",
        "phase-3"
      ],
      "total_tasks": 9,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-1": {
      "type": "phase",
      "title": "Fix fidelity gate evidence lifecycle",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-1-1",
        "verify-1-1"
      ],
      "total_tasks": 2,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Fix the bug where pending_gate_evidence is never cleared after address_fidelity_feedback succeeds, causing the fidelity gate to never re-run after remediation. The stale evidence re-fires _handle_gate_evidence until the cycle limit is hit and the session hard-pauses.",
        "estimated_hours": 2.0
      },
      "dependencies": {
        "blocks": [
          "phase-2"
        ],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-1": {
      "type": "task",
      "title": "Clear pending_gate_evidence on successful fidelity feedback",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "In orchestrator.py _record_step_outcome method, after the _record_gate_outcome call (~line 782), add conditional clearing of pending_gate_evidence when step_type is ADDRESS_FIDELITY_FEEDBACK and outcome is SUCCESS. Only clear on SUCCESS \u2014 FAILURE preserves evidence for re-evaluation. Do NOT reset fidelity_review_cycles_in_active_phase.",
        "file_path": "src/foundry_mcp/core/autonomy/orchestrator.py",
        "acceptance_criteria": [
          "pending_gate_evidence is set to None when step_type is ADDRESS_FIDELITY_FEEDBACK and outcome is SUCCESS",
          "pending_gate_evidence is preserved (not cleared) when outcome is FAILURE",
          "fidelity_review_cycles_in_active_phase counter is not reset by this change",
          "Clearing happens after _record_gate_outcome call and before journal write"
        ]
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-1-1": {
      "type": "verify",
      "title": "Add tests for gate evidence clearing",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Add new test class TestFidelityGateEvidenceClearing in test_orchestrator.py with 3 tests: (1) test_pending_gate_evidence_cleared_on_successful_feedback \u2014 verify _record_step_outcome clears evidence when step type is ADDRESS_FIDELITY_FEEDBACK and outcome is SUCCESS; (2) test_pending_gate_evidence_preserved_on_failed_feedback \u2014 verify evidence is NOT cleared when outcome is FAILURE; (3) test_full_fidelity_cycle_gate_fail_feedback_gate_retry \u2014 end-to-end test: gate fail \u2192 feedback success \u2192 next step is RUN_FIDELITY_GATE (not another feedback or pause). Follow existing test patterns using make_session, _issued, _result helpers.",
        "file_path": "tests/unit/test_core/autonomy/test_orchestrator.py",
        "verification_type": "run-tests"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-2": {
      "type": "phase",
      "title": "Improve step emission hints",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-2-1",
        "task-2-2",
        "verify-2-1"
      ],
      "total_tasks": 3,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Improve the step emission API to include outcome value hints in the message field and required parameter names in instruction descriptions. Both changes target step_emitters.py.",
        "estimated_hours": 2.0
      },
      "dependencies": {
        "blocks": [
          "phase-3"
        ],
        "blocked_by": [
          "phase-1"
        ],
        "depends": []
      }
    },
    "task-2-1": {
      "type": "task",
      "title": "Add _OUTCOME_HINT constant and populate message on action steps",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "In step_emitters.py, add a module-level constant _OUTCOME_HINT near existing error-code constants (~line 75-97): '_OUTCOME_HINT = When reporting this step, use outcome: \"success\", \"failure\", or \"skipped\".' Then set message= in 4 methods: _create_implement_task_step (message=f\"Implement task '{task_title}'. {_OUTCOME_HINT}\"), _create_verification_step (message=f\"Execute verification '{task_title}'. {_OUTCOME_HINT}\"), _create_fidelity_gate_step (message=f\"Run fidelity gate for phase '{phase_title}'. {_OUTCOME_HINT}\"), _create_fidelity_feedback_step (message=f\"Address fidelity feedback for phase {evidence.phase_id}. {_OUTCOME_HINT}\").",
        "file_path": "src/foundry_mcp/core/autonomy/step_emitters.py",
        "acceptance_criteria": [
          "_OUTCOME_HINT constant is defined near existing error-code constants",
          "All 4 step types (_create_implement_task_step, _create_verification_step, _create_fidelity_gate_step, _create_fidelity_feedback_step) have non-None message field",
          "Each message contains the valid outcome values: success, failure, skipped"
        ]
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-2": {
      "type": "task",
      "title": "Enrich fidelity step instructions with required params",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "In step_emitters.py, update instruction descriptions in _create_fidelity_gate_step: (1) review/fidelity-gate instruction description to include spec_id, phase_id, session_id, step_id values; (2) task/session-step-next instruction description to include step_type and gate_attempt_id. Update _create_fidelity_feedback_step: (1) review/fidelity instruction description to include spec_id and phase_id; (2) task/session-step-next instruction description to include step_type='address_fidelity_feedback'.",
        "file_path": "src/foundry_mcp/core/autonomy/step_emitters.py",
        "acceptance_criteria": [
          "Fidelity gate step review instruction includes spec_id, phase_id, session_id, step_id parameter values",
          "Fidelity gate step report instruction includes step_type and gate_attempt_id",
          "Fidelity feedback step review instruction includes spec_id and phase_id",
          "Fidelity feedback step report instruction includes step_type='address_fidelity_feedback'"
        ]
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-2-1": {
      "type": "verify",
      "title": "Add tests for step emission improvements",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "In test_orchestrator.py, add 2 tests: (1) test_step_message_includes_outcome_hint \u2014 verify the message field on action steps contains outcome values 'success', 'failure', 'skipped'; (2) test_fidelity_gate_instruction_includes_required_params \u2014 verify step instruction descriptions include step_id, session_id, spec_id, phase_id.",
        "file_path": "tests/unit/test_core/autonomy/test_orchestrator.py",
        "verification_type": "run-tests"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-3": {
      "type": "phase",
      "title": "Universal acceptance criteria enforcement",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-3-1",
        "task-3-2",
        "task-3-3",
        "verify-3-1"
      ],
      "total_tasks": 4,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Make acceptance criteria mandatory for all spec complexity levels (not just medium+) and include them in fidelity review context. Cross-cutting change across validation, hierarchy, and documentation helpers.",
        "estimated_hours": 3.0
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "phase-2"
        ],
        "depends": []
      }
    },
    "task-3-1": {
      "type": "task",
      "title": "Remove complexity gate from acceptance_criteria validation",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "In validation/rules.py (~line 819), move the acceptance_criteria validation block outside the 'if requires_rich_tasks:' guard. The block currently starts with 'if requires_rich_tasks:' and contains nested acceptance_criteria checks. Extract the acceptance_criteria checks (MISSING_ACCEPTANCE_CRITERIA, INVALID_ACCEPTANCE_CRITERIA diagnostics) so they fire for specs of ALL complexity levels. Keep existing diagnostic codes and messages. Other checks gated by requires_rich_tasks (description, etc.) stay as-is.",
        "file_path": "src/foundry_mcp/core/validation/rules.py",
        "acceptance_criteria": [
          "MISSING_ACCEPTANCE_CRITERIA diagnostic fires for specs of ALL complexity levels, not just medium+",
          "INVALID_ACCEPTANCE_CRITERIA diagnostic fires for specs of ALL complexity levels",
          "Other requires_rich_tasks checks (description, etc.) remain gated by complexity",
          "Existing diagnostic codes and messages are preserved"
        ]
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-2": {
      "type": "task",
      "title": "Remove complexity gate from add_phase_bulk authoring",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "In hierarchy.py (~line 603), move the acceptance_criteria requirement outside the 'if requires_rich_tasks:' block. add_phase_bulk should reject tasks without acceptance_criteria regardless of spec complexity.",
        "file_path": "src/foundry_mcp/core/spec/hierarchy.py",
        "acceptance_criteria": [
          "add_phase_bulk rejects tasks without acceptance_criteria regardless of spec complexity",
          "Error message preserved: Task '{task_title}' missing acceptance_criteria",
          "Error message preserved: Task '{task_title}' acceptance_criteria must include at least one entry"
        ]
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-3": {
      "type": "task",
      "title": "Include acceptance criteria in fidelity review context",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "In documentation_helpers.py _build_spec_requirements method, add acceptance_criteria to both task scope (lines 19-31) and phase scope (lines 32-43). For task scope: after file_path line, add acceptance criteria as bulleted list. For phase scope: after listing child task titles, add acceptance criteria under each child task.",
        "file_path": "src/foundry_mcp/tools/unified/documentation_helpers.py",
        "acceptance_criteria": [
          "Task scope shows acceptance criteria as bulleted list under '- **Acceptance Criteria:**' heading",
          "Phase scope shows criteria under each child task with '    - AC: {criterion}' format",
          "No changes when acceptance_criteria is missing or empty"
        ]
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-3-1": {
      "type": "verify",
      "title": "Add tests for universal acceptance criteria",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "In test_validation.py: (1) Update test_missing_acceptance_criteria_for_medium_spec to confirm criteria are required for medium specs; (2) Add test_missing_acceptance_criteria_for_simple_spec to verify that a spec without complexity metadata (or with simple complexity) still gets MISSING_ACCEPTANCE_CRITERIA diagnostic. Also add test in hierarchy tests to verify add_phase_bulk rejects tasks without acceptance_criteria regardless of spec complexity.",
        "file_path": "tests/unit/test_core/test_validation.py",
        "verification_type": "run-tests"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    }
  },
  "journal": []
}